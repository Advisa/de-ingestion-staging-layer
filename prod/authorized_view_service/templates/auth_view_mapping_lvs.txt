sambla_legacy_integration_legacy|applications_sambq_p|WITH data_with_ssn_rules AS (SELECT *, CASE WHEN market= "SE" THEN LEFT(REGEXP_REPLACE(CAST(raw.national_id AS STRING), "[^0-9]", ""), 12) WHEN market= "NO" THEN LEFT(REGEXP_REPLACE(CAST(raw.national_id AS STRING), "[^0-9]", ""), 11) WHEN market= "DK" THEN LEFT(REGEXP_REPLACE(CAST(raw.national_id AS STRING), "[^0-9]", ""), 10) WHEN market= "FI" THEN LEFT(REGEXP_REPLACE(UPPER(CAST(raw.national_id AS STRING)), "[^0-9-+A-Z]", ""), 11) END AS ssn_clean FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_sambq_p` raw) SELECT ARRAY(SELECT STRUCT(CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(f_partnerComments.userName AS STRING), VAULT.uuid)) ELSE CAST(f_partnerComments.userName AS STRING) END AS userName, f_partnerComments.removalReason, f_partnerComments.text, f_partnerComments.user, f_partnerComments._id, f_partnerComments.date) FROM UNNEST(partnerComments) AS f_partnerComments) AS partnerComments, ARRAY(SELECT STRUCT(f_allPaidOutByAdvisa._id, f_allPaidOutByAdvisa.date, f_allPaidOutByAdvisa.allowRefinance, f_allPaidOutByAdvisa.amount, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(f_allPaidOutByAdvisa.bank AS STRING), VAULT.uuid)) ELSE CAST(f_allPaidOutByAdvisa.bank AS STRING) END AS bank) FROM UNNEST(allPaidOutByAdvisa) AS f_allPaidOutByAdvisa) AS allPaidOutByAdvisa, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.national_id AS STRING), VAULT.uuid)) ELSE CAST(raw.national_id AS STRING) END AS national_id, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.name AS STRING), VAULT.uuid)) ELSE CAST(raw.name AS STRING) END AS name, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.address AS STRING), VAULT.uuid)) ELSE CAST(raw.address AS STRING) END AS address, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.bank AS STRING), VAULT.uuid)) ELSE CAST(raw.bank AS STRING) END AS bank, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.postalArea AS STRING), VAULT.uuid)) ELSE CAST(raw.postalArea AS STRING) END AS postalArea, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.originIPAddress AS STRING), VAULT.uuid)) ELSE CAST(raw.originIPAddress AS STRING) END AS originIPAddress, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.postalCode AS STRING), VAULT.uuid)) ELSE CAST(raw.postalCode AS STRING) END AS postalCode, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.person AS STRING), VAULT.uuid)) ELSE CAST(raw.person AS STRING) END AS person, raw.* EXCEPT(bank, originIPAddress, allPaidOutByAdvisa, partnerComments, address, postalCode, postalArea, name, person, national_id) FROM `data_with_ssn_rules` raw LEFT JOIN `sambla-group-compliance-db.compilance_database.gdpr_vault_rudolf` VAULT ON CAST(raw.ssn_clean AS STRING) = VAULT.ssn
sambla_legacy_integration_legacy|applications_all_versions_sambq_p|WITH data_with_ssn_rules AS (SELECT *, CASE WHEN market= "SE" THEN LEFT(REGEXP_REPLACE(CAST(raw.national_id AS STRING), "[^0-9]", ""), 12) WHEN market= "NO" THEN LEFT(REGEXP_REPLACE(CAST(raw.national_id AS STRING), "[^0-9]", ""), 11) WHEN market= "DK" THEN LEFT(REGEXP_REPLACE(CAST(raw.national_id AS STRING), "[^0-9]", ""), 10) WHEN market= "FI" THEN LEFT(REGEXP_REPLACE(UPPER(CAST(raw.national_id AS STRING)), "[^0-9-+A-Z]", ""), 11) END AS ssn_clean FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_all_versions_sambq_p` raw) SELECT ARRAY(SELECT STRUCT(f_partnerComments._id, f_partnerComments.user, f_partnerComments.date, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(f_partnerComments.userName AS STRING), VAULT.uuid)) ELSE CAST(f_partnerComments.userName AS STRING) END AS userName, f_partnerComments.text, f_partnerComments.removalReason) FROM UNNEST(partnerComments) AS f_partnerComments) AS partnerComments, ARRAY(SELECT STRUCT(f_allPaidOutByAdvisa.date, f_allPaidOutByAdvisa.amount, f_allPaidOutByAdvisa.allowRefinance, f_allPaidOutByAdvisa._id, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(f_allPaidOutByAdvisa.bank AS STRING), VAULT.uuid)) ELSE CAST(f_allPaidOutByAdvisa.bank AS STRING) END AS bank) FROM UNNEST(allPaidOutByAdvisa) AS f_allPaidOutByAdvisa) AS allPaidOutByAdvisa, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.national_id AS STRING), VAULT.uuid)) ELSE CAST(raw.national_id AS STRING) END AS national_id, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.name AS STRING), VAULT.uuid)) ELSE CAST(raw.name AS STRING) END AS name, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.address AS STRING), VAULT.uuid)) ELSE CAST(raw.address AS STRING) END AS address, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.bank AS STRING), VAULT.uuid)) ELSE CAST(raw.bank AS STRING) END AS bank, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.postalArea AS STRING), VAULT.uuid)) ELSE CAST(raw.postalArea AS STRING) END AS postalArea, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.originIPAddress AS STRING), VAULT.uuid)) ELSE CAST(raw.originIPAddress AS STRING) END AS originIPAddress, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.idNumber AS STRING), VAULT.uuid)) ELSE CAST(raw.idNumber AS STRING) END AS idNumber, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.accountNumber AS STRING), VAULT.uuid)) ELSE CAST(raw.accountNumber AS STRING) END AS accountNumber, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.clearingNumber AS STRING), VAULT.uuid)) ELSE CAST(raw.clearingNumber AS STRING) END AS clearingNumber, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.postalCode AS STRING), VAULT.uuid)) ELSE CAST(raw.postalCode AS STRING) END AS postalCode, CASE WHEN VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.person AS STRING), VAULT.uuid)) ELSE CAST(raw.person AS STRING) END AS person, raw.* EXCEPT(bank, originIPAddress, allPaidOutByAdvisa, partnerComments, idNumber, accountNumber, clearingNumber, address, postalCode, postalArea, name, person, national_id) FROM `data_with_ssn_rules` raw LEFT JOIN `sambla-group-compliance-db.compilance_database.gdpr_vault_rudolf` VAULT ON CAST(raw.ssn_clean AS STRING) = VAULT.ssn
sambla_legacy_integration_legacy|applications_estates_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_estates_sambq_p`
sambla_legacy_integration_legacy|users_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.users_sambq_p`
sambla_legacy_integration_legacy|applications_customers_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_customers_sambq_p`
sambla_legacy_integration_legacy|applications_invites_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_invites_sambq_p`
sambla_legacy_integration_legacy|banks_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.banks_sambq_p`
sambla_legacy_integration_legacy|applications_bids_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_bids_sambq_p`
sambla_legacy_integration_legacy|applications_loans_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_loans_sambq_p`
sambla_legacy_integration_legacy|applications_credit_reports_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_credit_reports_sambq_p`
sambla_legacy_integration_legacy|applications_past_report_requests_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_past_report_requests_sambq_p`
sambla_legacy_integration_legacy|applications_utmhistory_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_utmhistory_sambq_p`
sambla_legacy_integration_legacy|applications_excludebanks_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_excludebanks_sambq_p`
sambla_legacy_integration_legacy|applications_allpaidoutbysambla_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_allpaidoutbysambla_sambq_p`
sambla_legacy_integration_legacy|applications_scheduledcalls_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_scheduledcalls_sambq_p`
sambla_legacy_integration_legacy|applications_internalcomments_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_internalcomments_sambq_p`
sambla_legacy_integration_legacy|applications_version_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.applications_version_sambq_p`
sambla_legacy_integration_legacy|unsubscriptions_sambq_p|SELECT * FROM `sambla-data-staging-compliance.sambla_legacy_integration_legacy.unsubscriptions_sambq_p`
