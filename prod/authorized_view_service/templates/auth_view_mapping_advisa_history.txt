advisa_history_integration_legacy|applications_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.applications_adhis_r`
advisa_history_integration_legacy|applicants_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.applicants_adhis_r`
advisa_history_integration_legacy|payment_insurance_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.payment_insurance_adhis_r`
advisa_history_integration_legacy|insurance_repayments_mutual_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_repayments_mutual_adhis_r`
advisa_history_integration_legacy|tags_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.tags_adhis_r`
advisa_history_integration_legacy|invites_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.invites_adhis_r`
advisa_history_integration_legacy|insurance_partners_mdn_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_partners_mdn_adhis_r`
advisa_history_integration_legacy|subscription_month_invoice_items_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.subscription_month_invoice_items_adhis_r`
advisa_history_integration_legacy|insurance_invoice_lines_mutual_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_invoice_lines_mutual_adhis_r`
advisa_history_integration_legacy|payments_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.payments_adhis_r`
advisa_history_integration_legacy|insurance_payment_insurances_mutual_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_payment_insurances_mutual_adhis_r`
advisa_history_integration_legacy|insurance_policy_products_mdn_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_policy_products_mdn_adhis_r`
advisa_history_integration_legacy|invoices_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.invoices_adhis_r`
advisa_history_integration_legacy|insurance_invoices_mutual_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_invoices_mutual_adhis_r`
advisa_history_integration_legacy|insurance_insurance_invoices_mutual_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_insurance_invoices_mutual_adhis_r`
advisa_history_integration_legacy|insurance_cancellations_mdn_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_cancellations_mdn_adhis_r`
advisa_history_integration_legacy|payment_insurance_levels_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.payment_insurance_levels_adhis_r`
advisa_history_integration_legacy|pageviews_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.pageviews_adhis_r`
advisa_history_integration_legacy|credit_report_groups_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.credit_report_groups_adhis_r`
advisa_history_integration_legacy|insurance_invoice_items_mutual_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_invoice_items_mutual_adhis_r`
advisa_history_integration_legacy|interactions_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.interactions_adhis_r`
advisa_history_integration_legacy|credit_report_group_items_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.credit_report_group_items_adhis_r`
advisa_history_integration_legacy|bids_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.bids_adhis_r`
advisa_history_integration_legacy|people_adhis_r|WITH data_with_ssn_rules AS (SELECT *, LEFT(REGEXP_REPLACE(CAST(raw.national_id_sensitive AS STRING), "[^0-9]", ""), 12) AS ssn_clean FROM`sambla-data-staging-compliance.advisa_history_integration_legacy.people_adhis_r` raw) SELECT CASE WHEN raw.national_id_sensitive IS NOT NULL  AND raw.national_id_sensitive <> 0 AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.national_id_sensitive AS STRING), VAULT.uuid)) ELSE CAST(raw.national_id_sensitive AS STRING) END AS national_id_sensitive, raw.* EXCEPT(national_id_sensitive),CASE WHEN (raw.national_id_sensitive IS NOT NULL AND raw.national_id_sensitive <> "" AND VAULT.uuid IS NOT NULL) OR LOWER(raw.national_id_sensitive) =  "anonymized" THEN TRUE ELSE FALSE END AS is_anonymised FROM `data_with_ssn_rules` raw LEFT JOIN `sambla-group-compliance-db.compilance_database.gdpr_vault_rudolf` VAULT ON CAST(raw.ssn_clean AS STRING) = VAULT.ssn
advisa_history_integration_legacy|creditors_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.creditors_adhis_r`
advisa_history_integration_legacy|insurance_customers_mdn_adhis_r|WITH data_with_ssn_rules AS (SELECT *, LEFT(REGEXP_REPLACE(CAST(raw.customer_ssn AS STRING), "[^0-9]", ""), 12) AS ssn_clean FROM`sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_customers_mdn_adhis_r` raw) SELECT CASE WHEN raw.customer_organisation_name IS NOT NULL  AND raw.customer_organisation_name <> '' AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_organisation_name AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_organisation_name AS STRING) END AS customer_organisation_name, CASE WHEN raw.customer_organisation_number IS NOT NULL  AND raw.customer_organisation_number <> 0 AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_organisation_number AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_organisation_number AS STRING) END AS customer_organisation_number, CASE WHEN raw.customer_first_name IS NOT NULL  AND raw.customer_first_name <> '' AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_first_name AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_first_name AS STRING) END AS customer_first_name, CASE WHEN raw.customer_last_name IS NOT NULL  AND raw.customer_last_name <> '' AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_last_name AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_last_name AS STRING) END AS customer_last_name, CASE WHEN raw.customer_address IS NOT NULL  AND raw.customer_address <> '' AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_address AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_address AS STRING) END AS customer_address, CASE WHEN raw.customer_address2 IS NOT NULL  AND raw.customer_address2 <> '' AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_address2 AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_address2 AS STRING) END AS customer_address2, CASE WHEN raw.customer_postal_code IS NOT NULL  AND raw.customer_postal_code <> '' AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_postal_code AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_postal_code AS STRING) END AS customer_postal_code, CASE WHEN raw.customer_city IS NOT NULL  AND raw.customer_city <> '' AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_city AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_city AS STRING) END AS customer_city, CASE WHEN raw.customer_state IS NOT NULL  AND raw.customer_state <> '' AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_state AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_state AS STRING) END AS customer_state, CASE WHEN raw.customer_country_name IS NOT NULL  AND raw.customer_country_name <> '' AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_country_name AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_country_name AS STRING) END AS customer_country_name, CASE WHEN raw.customer_ssn IS NOT NULL  AND raw.customer_ssn <> '' AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_ssn AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_ssn AS STRING) END AS customer_ssn, CASE WHEN raw.customer_phone IS NOT NULL  AND raw.customer_phone <> '' AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_phone AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_phone AS STRING) END AS customer_phone, CASE WHEN raw.customer_email IS NOT NULL  AND raw.customer_email <> '' AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_email AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_email AS STRING) END AS customer_email, CASE WHEN raw.customer_passport_number IS NOT NULL  AND raw.customer_passport_number <> '' AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_passport_number AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_passport_number AS STRING) END AS customer_passport_number, CASE WHEN raw.customer_passport_issuance_country_name IS NOT NULL  AND raw.customer_passport_issuance_country_name <> '' AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.customer_passport_issuance_country_name AS STRING), VAULT.uuid)) ELSE CAST(raw.customer_passport_issuance_country_name AS STRING) END AS customer_passport_issuance_country_name, raw.* EXCEPT(customer_organisation_name, customer_organisation_number, customer_first_name, customer_last_name, customer_address, customer_address2, customer_postal_code, customer_city, customer_state, customer_country_name, customer_ssn, customer_phone, customer_email, customer_passport_number, customer_passport_issuance_country_name),CASE WHEN (raw.customer_ssn IS NOT NULL AND raw.customer_ssn <> "" AND VAULT.uuid IS NOT NULL) OR LOWER(raw.customer_ssn) =  "anonymized" THEN TRUE ELSE FALSE END AS is_anonymised FROM `data_with_ssn_rules` raw LEFT JOIN `sambla-group-compliance-db.compilance_database.gdpr_vault_rudolf` VAULT ON CAST(raw.ssn_clean AS STRING) = VAULT.ssn
advisa_history_integration_legacy|insurance_users_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_users_adhis_r`
advisa_history_integration_legacy|advisor_users_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.advisor_users_adhis_r`
advisa_history_integration_legacy|credit_report_details_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.credit_report_details_adhis_r`
advisa_history_integration_legacy|archived_ssn|WITH data_with_ssn_rules AS (SELECT *, LEFT(REGEXP_REPLACE(CAST(raw.national_id AS STRING), "[^0-9]", ""), 12) AS ssn_clean FROM`sambla-data-staging-compliance.advisa_history_integration_legacy.archived_ssn` raw) SELECT CASE WHEN raw.national_id IS NOT NULL  AND raw.national_id <> 0 AND VAULT.uuid IS NOT NULL THEN TO_HEX(SAFE.DETERMINISTIC_ENCRYPT(VAULT.aead_key, CAST(raw.national_id AS STRING), VAULT.uuid)) ELSE CAST(raw.national_id AS STRING) END AS national_id, raw.* EXCEPT(national_id),CASE WHEN (raw.national_id IS NOT NULL AND raw.national_id <> "" AND VAULT.uuid IS NOT NULL) OR LOWER(raw.national_id) =  "anonymized" THEN TRUE ELSE FALSE END AS is_anonymised FROM `data_with_ssn_rules` raw LEFT JOIN `sambla-group-compliance-db.compilance_database.gdpr_vault_rudolf` VAULT ON CAST(raw.ssn_clean AS STRING) = VAULT.ssn
advisa_history_integration_legacy|cookies_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.cookies_adhis_r`
advisa_history_integration_legacy|insurance_payment_insurance_levels_mutual_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_payment_insurance_levels_mutual_adhis_r`
advisa_history_integration_legacy|insurance_partners_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_partners_adhis_r`
advisa_history_integration_legacy|insurance_payments_mutual_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_payments_mutual_adhis_r`
advisa_history_integration_legacy|insurance_transactions_mdn_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_transactions_mdn_adhis_r`
advisa_history_integration_legacy|credit_reports_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.credit_reports_adhis_r`
advisa_history_integration_legacy|insurance_policies_mdn_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_policies_mdn_adhis_r`
advisa_history_integration_legacy|payment_insurances_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.payment_insurances_adhis_r`
advisa_history_integration_legacy|subscriptions_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.subscriptions_adhis_r`
advisa_history_integration_legacy|insurance_users_mdn_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_users_mdn_adhis_r`
advisa_history_integration_legacy|insurance_payment_insurance_logs_mutual_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_payment_insurance_logs_mutual_adhis_r`
advisa_history_integration_legacy|insurance_policy_types_mdn_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.insurance_policy_types_mdn_adhis_r`
advisa_history_integration_legacy|invoice_items_adhis_r|SELECT *, False AS is_anonymised FROM `sambla-data-staging-compliance.advisa_history_integration_legacy.invoice_items_adhis_r`