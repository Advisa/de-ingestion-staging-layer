resource "google_iam_deny_policy" "deny_policy_creation" {
  parent      = urlencode("cloudresourcemanager.googleapis.com/projects/${var.data_domain_project_id}")  # Corrected parent format
  name        = "gdpr-deny-policy-prod"
  display_name = "GDPR deny policy"
  rules {
    description = "First rule"
    deny_rule {
      denied_principals = ["principalSet://goog/public:all","principal://iam.googleapis.com/projects/-/serviceAccounts/duygu-bigquery@data-domain-data-warehouse.iam.gserviceaccount.com"]
      exception_principals = ["principal://iam.googleapis.com/projects/-/serviceAccounts/search-console@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/yang-service@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/temporary-sa@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/sales-export-bot@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/hex-tech-reader@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/transformer@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/257103301937-compute@developer.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/deploy-dbt-doc-app-engine@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/dbt-cloud-job-runner@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/adam-svenson@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/extractor@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/cloud-build-service-account@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/retool@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/dev-experiment@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/dev-ab-testing@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/business-analyst@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/dataform-poc@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/bigquery-segment@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/dev-uploads@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/dataform-poc1@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/doit-cmp@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/derek-911@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/dev-data-api-user@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/power-bi@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/test-sftp-sambla@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/facebook-audiences@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/airbyte-loader@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/pubsub-publisher@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/google-sheets-marketing@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/suresh-service@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/de-ingestion-schemaregistry@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/ddddddd@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/dev-event-publisher@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/cloud-run-pubsub-invoker@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/realtime-leaderboards@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/jitsu-test@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/checkbiz-data-pipeline@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/slim-ayadi@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/leaddesk-integration@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/data-domain-data-warehouse@appspot.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/web-team@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/rahalaitos-data@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/prefect-work-pool-push-worker@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/looker-studio@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/github-action-auth@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/de-terraform@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/prefect-scheduled-query-runner@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/data-flow-pipeline@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/monitoring@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/peyman-safari@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/firestore-to-bigquery@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/goog-sc-load-balanced-vms-949@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/test-policy-tags@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/partial-submit-handler@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/authorised-view-service-acc@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/test-service-account-duygu@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/kinesis-datastream-to-pubsub@data-domain-data-warehouse.iam.gserviceaccount.com", "principal://iam.googleapis.com/projects/-/serviceAccounts/de-dim-pubsub-forwarder@data-domain-data-warehouse.iam.gserviceaccount.com","principalSet://goog/group/data@samblagroup.com"]
      denial_condition {
        title       = "denial condition expression"
        expression = "resource.matchTagId(\"tagKeys/${google_tags_tag_key.tag_key_prod_live.name}\", \"tagValues/${google_tags_tag_value.tag_value_prod_live.name}\")"
      }
      denied_permissions = ["bigquery.googleapis.com/datasets.get", "bigquery.googleapis.com/datasets.update", "bigquery.googleapis.com/tables.create", "bigquery.googleapis.com/tables.delete", "bigquery.googleapis.com/tables.get", "bigquery.googleapis.com/tables.update", "bigquery.googleapis.com/jobs.create", "bigquery.googleapis.com/datasets.create", "bigquery.googleapis.com/jobs.get", "bigquery.googleapis.com/jobs.list", "bigquery.googleapis.com/jobs.listAll", "bigquery.googleapis.com/jobs.delete", "bigquery.googleapis.com/jobs.update", "bigquery.googleapis.com/tables.createIndex", "bigquery.googleapis.com/tables.createSnapshot", "bigquery.googleapis.com/tables.createTagBinding", "bigquery.googleapis.com/tables.deleteIndex", "bigquery.googleapis.com/tables.deleteSnapshot", "bigquery.googleapis.com/tables.deleteTagBinding", "bigquery.googleapis.com/tables.export", "bigquery.googleapis.com/tables.getIamPolicy", "bigquery.googleapis.com/tables.updateData", "bigquery.googleapis.com/models.getData","bigquery.googleapis.com/tables.getData"]  # Permissions to be denied
    }
  }
}
